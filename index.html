<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monitor Sísmico – SAN_JOSE (NAZCA & PIURA)</title>
<style>
  :root{--ok:#2e7d32;--leve:#f57c00;--alta:#c62828;}
  body{font-family:system-ui,Arial,sans-serif;margin:20px;line-height:1.35}
  h1{margin:0 0 8px 0}
  .muted{color:#666}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0}
  label{font-size:14px}
  select,input[type=text]{padding:6px 8px;border:1px solid #ccc;border-radius:8px;min-width:260px}
  button{padding:7px 12px;border-radius:10px;border:1px solid #ccc;cursor:pointer;background:#fafafa}
  .status{padding:4px 10px;border-radius:16px;background:#eee}
  .ok{color:var(--ok)} .leve{color:var(--leve)} .alta{color:var(--alta)}
  table{border-collapse:collapse;width:100%;max-width:1100px;margin-top:10px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#f5f5f5}
  .pill{padding:2px 8px;border-radius:12px;display:inline-block}
  .small{font-size:12px}
</style>
</head>
<body>
<h1>Monitor Sísmico – SAN_JOSE (NAZCA & PIURA)</h1>
<p class="muted small">
  Namespace: <code>jesusyarangacha-svg/san_jose/v1</code> ·
  Topics: <code>.../devices/&lt;deviceId&gt;/estado</code> · <code>status</code> · <code>heartbeat</code>
</p>

<div class="row">
  <label>Broker (WSS):</label>
  <select id="brokerSelect">
    <option value="wss://mqtt.eclipseprojects.io:443/mqtt">Eclipse — wss://mqtt.eclipseprojects.io:443/mqtt</option>
    <option value="wss://broker.hivemq.com:8884/mqtt">HiveMQ — wss://broker.hivemq.com:8884/mqtt</option>
    <option value="wss://broker.emqx.io:8084/mqtt">EMQX — wss://broker.emqx.io:8084/mqtt</option>
    <option value="wss://test.mosquitto.org:8081/mqtt">Mosquitto — wss://test.mosquitto.org:8081/mqtt</option>
  </select>
  <input id="brokerCustom" type="text" placeholder="o pega aquí otra URL WSS (ej. wss://mi-dominio.com/mqtt)" />
</div>

<div class="row">
  <label>Filtrar por deviceId (opcional):</label>
  <input id="filterDevice" type="text" placeholder="ej. esp32-1A2B" />
  <button id="btnConnect">Conectar</button>
  <button id="btnDisconnect">Desconectar</button>
  <button id="btnDemo">Publicar demo</button>
  <div class="status" id="conn">Estado: desconectado</div>
</div>

<table>
  <thead>
    <tr>
      <th>Device</th><th>Nivel</th><th>NAZCA</th><th>PIURA</th><th>Total</th>
      <th>Último</th><th>IP</th><th>Online</th><th>Uptime(s)</th><th>RSSI</th><th>Hora</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<p class="muted small">La web se suscribe a:
  <code id="subsEstado"></code>, <code id="subsStatus"></code> y <code id="subsHB"></code>
</p>

<!-- ===== MQTT.js con fallback de 3 CDNs ===== -->
<script>
  const MQTT_CDNS = [
    "https://cdn.jsdelivr.net/npm/mqtt/dist/mqtt.min.js",
    "https://unpkg.com/mqtt/dist/mqtt.min.js",
    "https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.10.1/mqtt.min.js"
  ];
  function loadScriptSeq(urls){
    return new Promise((resolve, reject)=>{
      let i = 0;
      const tryNext = ()=>{
        if(i >= urls.length) return reject(new Error("No se pudo cargar MQTT.js desde los CDNs"));
        const s = document.createElement("script");
        s.src = urls[i++];
        s.onload = ()=> resolve();
        s.onerror = ()=> { s.remove(); tryNext(); };
        document.head.appendChild(s);
      };
      tryNext();
    });
  }
</script>

<script>
  // ======== CONFIG ========
  const NS = "jesusyarangacha-svg/san_jose/v1";
  const TOPIC_ESTADO    = NS + "/devices/+/estado";
  const TOPIC_STATUS    = NS + "/devices/+/status";
  const TOPIC_HEARTBEAT = NS + "/devices/+/heartbeat";

  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById('subsEstado').textContent = TOPIC_ESTADO;
    document.getElementById('subsStatus').textContent = TOPIC_STATUS;
    document.getElementById('subsHB').textContent     = TOPIC_HEARTBEAT;
  });

  // ======== UI & STATE ========
  let client = null;
  const rows  = {}; // deviceId -> <tr>

  function nivelClass(n){
    if(n === "OK") return "ok";
    if(n === "LEVE") return "leve";
    return "alta";
  }
  function setConn(state){
    document.getElementById('conn').textContent = "Estado: " + state;
  }
  function getSelectedBroker(){
    const custom = document.getElementById('brokerCustom').value.trim();
    if (custom) return custom;
    return document.getElementById('brokerSelect').value;
  }
  function getDeviceFromTopic(topic){
    // NS/devices/<deviceId>/<kind>
    const p = topic.split("/");
    if (p.length >= 6) return { id: p[4], kind: p[5] };
    return { id: "?", kind: "?" };
  }
  function upsertRow(device){
    const tbody = document.getElementById('tbody');
    let tr = rows[device];
    if(!tr){
      tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="device"></td>
        <td class="nivel"></td>
        <td class="nazca"></td>
        <td class="piura"></td>
        <td class="total"></td>
        <td class="ultimo"></td>
        <td class="ip"></td>
        <td class="online"></td>
        <td class="uptime"></td>
        <td class="rssi"></td>
        <td class="hora"></td>`;
      tbody.appendChild(tr);
      rows[device] = tr;
    }
    return tr;
  }
  function applyFilter(deviceId){
    const filter = document.getElementById('filterDevice').value.trim();
    return (!filter || filter === deviceId);
  }
  function handleEstado(deviceId, payload){
    if (!applyFilter(deviceId)) return;
    const tr = upsertRow(deviceId);
    tr.querySelector('.device').textContent = deviceId;
    tr.querySelector('.nivel').innerHTML = `<span class="pill ${nivelClass(payload.nivel)}">${payload.nivel}</span>`;
    tr.querySelector('.nazca').textContent  = payload.nazca;
    tr.querySelector('.piura').textContent  = payload.piura;
    tr.querySelector('.total').textContent  = payload.total;
    tr.querySelector('.ultimo').textContent = payload.ultimo;
    tr.querySelector('.ip').textContent     = payload.ip || "";
    tr.querySelector('.hora').textContent   = new Date().toLocaleTimeString();
  }
  function handleStatus(deviceId, text){
    if (!applyFilter(deviceId)) return;
    const tr = upsertRow(deviceId);
    tr.querySelector('.device').textContent = deviceId;
    tr.querySelector('.online').textContent = text;
  }
  function handleHeartbeat(deviceId, payload){
    if (!applyFilter(deviceId)) return;
    const tr = upsertRow(deviceId);
    tr.querySelector('.device').textContent = deviceId;
    tr.querySelector('.uptime').textContent = (payload.uptime ?? "");
    tr.querySelector('.rssi').textContent   = (payload.rssi   ?? "");
    tr.querySelector('.hora').textContent   = new Date().toLocaleTimeString();
  }

  // ======== MQTT (MQTT.js) ========
  function connect(){
    disconnect(); // limpia si había una previa
    const brokerURL = getSelectedBroker();
    const clientId = "web-" + Math.random().toString(16).slice(2);

    try {
      // Conectar con MQTT.js
      client = mqtt.connect(brokerURL, {
        clientId,
        clean: true,
        connectTimeout: 8000,
        reconnectPeriod: 0,   // sin auto-reconnect (controlado por botones)
      });
    } catch(e){
      alert("No pude crear cliente MQTT: " + e);
      return;
    }

    client.on('connect', () => {
      setConn("conectado");
      client.subscribe(TOPIC_ESTADO,  { qos: 0 });
      client.subscribe(TOPIC_STATUS,  { qos: 0 });
      client.subscribe(TOPIC_HEARTBEAT, { qos: 0 });
    });

    client.on('message', (topic, payloadBuf) => {
      const payloadStr = payloadBuf.toString();
      const { id, kind } = getDeviceFromTopic(topic);
      try{
        if (kind === "estado")        handleEstado(id, JSON.parse(payloadStr));
        else if (kind === "heartbeat") handleHeartbeat(id, JSON.parse(payloadStr));
        else if (kind === "status")    handleStatus(id, payloadStr);
      }catch(e){ console.error("Error parseando", e, topic, payloadStr); }
    });

    client.on('error', (err) => { setConn("error"); console.error("MQTT error:", err.message || err); });
    client.on('close', () => setConn("desconectado"));
    client.on('offline', () => setConn("offline"));
    client.on('reconnect', () => setConn("reconectando..."));
  }

  function disconnect(){
    try{
      if (client) { client.end(true); }
      setConn("desconectado");
      client = null;
    }catch(e){}
  }

  function publishDemo(){
    if (!client) { alert("No conectado"); return; }
    const ns = "jesusyarangacha-svg/san_jose/v1";
    const topic = ns + "/devices/web-demo/estado";
    const payload = JSON.stringify({device:"web-demo",nivel:"LEVE",nazca:1,piura:0,total:1,ultimo:"NAZCA",ip:"-"});
    client.publish(topic, payload, { qos:0, retain:true }, (err)=> {
      if (err) alert("Error publicando demo: " + err);
      else alert("Demo publicada en " + topic);
    });
  }

  function initButtons(){
    document.getElementById('btnConnect').onclick = connect;
    document.getElementById('btnDisconnect').onclick = disconnect;
    document.getElementById('btnDemo').onclick = publishDemo;
  }

  // Carga MQTT.js y luego inicializa UI + conecta
  window.addEventListener('load', ()=>{
    loadScriptSeq(MQTT_CDNS)
      .then(()=>{ initButtons(); connect(); })
      .catch((e)=> alert("No se pudo cargar la librería MQTT.js.\nDetalle: " + e.message + "\nPrueba recargar la página o desactivar bloqueadores."));
  });
</script>
</body>
</html>
