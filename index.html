<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monitor Sísmico (NAZCA & PIURA) – Debug</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:20px}
  .ok{color:#2e7d32}.leve{color:#f57c00}.alta{color:#c62828}
  table{border-collapse:collapse;width:100%;max-width:900px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#f5f5f5}
  .pill{padding:2px 8px;border-radius:12px;display:inline-block}
  .muted{color:#666}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .status{padding:4px 10px;border-radius:16px;background:#eee}
  button{padding:6px 10px;border-radius:10px;border:1px solid #ccc;cursor:pointer}
</style>
</head>
<body>
<h1>Monitor Sísmico – Demo (NAZCA & PIURA)</h1>
<div class="row">
  <div>Broker: <code id="broker">wss://test.mosquitto.org:8081/mqtt</code></div>
  <div>Topic: <code id="topic">demo/sismo/+/estado</code></div>
  <div class="status" id="conn">Estado: desconectado</div>
  <button id="btnDemo" title="Publica un mensaje de prueba en demo/sismo/web-demo/estado">Publicar demo</button>
</div>
<p class="muted">Si no ves datos, pulsa <b>Publicar demo</b>. Si aparece una fila, la conexión por WebSockets funciona y el problema está en el ESP32/publicación MQTT.</p>

<table>
  <thead>
    <tr>
      <th>Device</th><th>Nivel</th><th>NAZCA</th><th>PIURA</th><th>Total</th><th>Último</th><th>IP</th><th>Hora</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
<script>
  const BROKER_URL = "wss://mqtt.eclipseprojects.io/mqtt";
  const SUB_TOPIC  = "demo/sismo/+/estado";
  const TEST_TOPIC = "demo/sismo/web-demo/estado";

  const clientId = "web-" + Math.random().toString(16).slice(2);
  const client = new Paho.MQTT.Client(BROKER_URL, clientId);

  const tbody = document.getElementById('tbody');
  const rows = {}; // device -> <tr>
  const conn = document.getElementById('conn');
  document.getElementById('broker').textContent = BROKER_URL;
  document.getElementById('topic').textContent  = SUB_TOPIC;

  function setConn(state){ conn.textContent = "Estado: " + state; }

  function nivelClass(n){ if(n==="OK")return"ok"; if(n==="LEVE")return"leve"; return"alta"; }

  function upsertRow(data){
    const d = data.device || "desconocido";
    let tr = rows[d];
    if(!tr){
      tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="device"></td>
        <td class="nivel"></td>
        <td class="nazca"></td>
        <td class="piura"></td>
        <td class="total"></td>
        <td class="ultimo"></td>
        <td class="ip"></td>
        <td class="hora"></td>
      `;
      tbody.appendChild(tr);
      rows[d] = tr;
    }
    tr.querySelector('.device').textContent = d;
    tr.querySelector('.nivel').innerHTML = `<span class="pill ${nivelClass(data.nivel)}">${data.nivel}</span>`;
    tr.querySelector('.nazca').textContent  = data.nazca;
    tr.querySelector('.piura').textContent  = data.piura;
    tr.querySelector('.total').textContent  = data.total;
    tr.querySelector('.ultimo').textContent = data.ultimo;
    tr.querySelector('.ip').textContent     = data.ip || "";
    tr.querySelector('.hora').textContent   = new Date().toLocaleTimeString();
  }

  client.onConnectionLost = (res) => {
    console.log("Conexión perdida:", res.errorMessage);
    setConn("desconectado");
    setTimeout(()=>client.connect({useSSL:true,onSuccess:onConnect}), 1500);
  };

  client.onMessageArrived = (msg) => {
    try { upsertRow(JSON.parse(msg.payloadString)); }
    catch(e){ console.error("JSON inválido:", e, msg.payloadString); }
  };

  function onConnect(){ console.log("Conectado (Web)"); setConn("conectado"); client.subscribe(SUB_TOPIC); }

  client.connect({useSSL:true,timeout:5,onSuccess:onConnect,onFailure:(e)=>{
    console.error("Fallo conexión:", e.errorMessage);
    setConn("fallo conexión");
    setTimeout(()=>client.connect({useSSL:true,onSuccess:onConnect}), 2000);
  }});

  // Botón: publicar demo
  document.getElementById('btnDemo').onclick = () => {
    if (!client.isConnected()) return alert("No conectado al broker (WSS)");
    const msg = new Paho.MQTT.Message(JSON.stringify({
      device: "web-demo", nivel: "LEVE", nazca: 1, piura: 0, total: 1, ultimo: "NAZCA", ip: "-"
    }));
    msg.destinationName = TEST_TOPIC;
    msg.retained = true;
    client.send(msg);
    alert("Demo publicada en " + TEST_TOPIC);
  };
</script>
</body>
</html>
